# Arithmetic on large natural numbers.

base â† âŠ‘ â€¢args âˆ¾ 2â‹†24
! 1=â€¢Type base â‹„ ! (âŒŠâŠ¸=âˆ§0âŠ¸â‰¤) base
! (Ã—Ëœbase) â‰¤ 2â‹†53

_while_ â† {ğ”½âŸğ”¾âˆ˜ğ”½_ğ•£_ğ”¾âˆ˜ğ”½âŸğ”¾ğ•©}

Valid â† {
  1==ğ•©? âˆ§Â´1=â€¢TypeÂ¨ğ•©? âˆ§Â´(âŒŠâŠ¸=âˆ§0âŠ¸â‰¤âˆ§<âŸœbase)ğ•©? # List of integers in [0,base)
  (0<â‰ )â—¶âŸ¨1,0â‰ âŠ¢Â´âŸ©ğ•©? 1 ;                    # Highest-order one isn't 0
  0
}
Trim â† { ğ•© â†‘Ëœ -âŸœ1 _while_ (â‰¥â—¶âŸ¨0,0=-âŠ‘ğ•©Ë™âŸ©âŸœ1) â‰ ğ•© }

From â‡ {
  ğ•Šâ¼ğ•©: ! Valid ğ•© â‹„ ToNum ğ•© ;
  ! 1 = â€¢Type ğ•©
  ! (0â‰¤ğ•©) âˆ§ ğ•©<âˆ
  ! âŒŠâŠ¸=ğ•©
  {0:â†•0; mâˆ¾ğ•ŠbaseÃ·Ëœğ•©-mâ†base|ğ•©} ğ•©
}
ToNum â‡ { râ†ğ•¨+baseÃ—ğ•© â‹„ "inexact"!ğ•¨=base|r â‹„ r }Â´
NearestNum â‡ {
  base = 2â‹†lâ†2â‹†â¼base? dâ†0âŒˆ(â‰ ğ•©)-âŒˆ53Ã·l â‹„ (2â‹†lÃ—d) Ã— +âŸœ(baseâŠ¸Ã—)Â´ dâ†“ğ•© ;
  ! "Non-powers of 2 not yet implemented"
}

Carry â† {
  b â† ğ•¨ âŠ£ 0           # Carry in
  g â† ğ•© â‰¥ base        # Generate
  p â† ğ•© = base-1      # Propagate
  i â† âŒˆ`âˆ˜Ã—âŸœ(1+â†•âˆ˜â‰ )Â¬p  # Start index of propagation chain
  a â† i âŠ gsâ†bâˆ¾g      # Active propagations
  c â† g âˆ¨ p âˆ§ a       # Carry from these positions
  r â† (ğ•© + bÂ»c) - cÃ—base
  âŸ¨r, câŠ¸Â«âŒ¾â‹ˆbâŸ©
}
_extend â† { ğ•¨ ğ”½â—‹((ğ•¨âŒˆâ—‹â‰ ğ•©)âŠ¸â†‘) ğ•© }
Add â‡ {
  0âŠ¸<â—¶âŠ£â€¿âˆ¾Â´ Carry ğ•¨ +_extend ğ•©
}
Sub â‡ {
  ! ğ•¨ â‰¥â—‹â‰  ğ•©
  sâ€¿c â† 1 Carry ğ•¨ (âŠ£ + (base-1)-âŠ¢)_extend ğ•©
  ! 1 = c
  Trim s
}

Mul â‡ {
  512 < nâ†ğ•¨âŒŠâ—‹â‰ ğ•© ? # Karatsuba
    kâ†âŒŠnÃ·2
    # AddâŸœ((kâ¥Š0)âŠ¸âˆ¾){ğ”½Â´ğ”½Â¨Ë} ğ•¨ ğ•ŠâŒœâ—‹(kâŠ¸(â†‘â‹ˆâ†“)) ğ•©  but one less ğ•Š
    lâ€¿hâ€¿a â† ğ•¨ ğ•ŠÂ¨â—‹(âˆ¾âŸœ(<AddÂ´)kâŠ¸(â†‘â‹ˆâ†“)) ğ•©
    AddâŸœ((kâ¥Š0)âŠ¸âˆ¾)Â´ âŸ¨l, a Sub l Add h, hâŸ©
  ;
  0 = ğ•¨âŒŠâ—‹â‰ ğ•© ? â†•0 ;
  q â† Ã—Ëœbase                           # Maintain âˆ§Â´s<q
  sâ†o â† 0Â¨ğ•©                            # Sum, overflow
  p â† {câ†qâ‰¤aâ†ğ•©+Â«s â‹„ sâ†©a-cÃ—q â‹„ oâ†©c+Â«o â‹„ âŠ‘Â¨sâ€¿o}âˆ˜Ã—âŸœğ•©Â¨ ğ•¨
  sâ€¿o âˆ¾ËœÂ¨â†© <Ë˜â‰Â¯1â†“>p                    # Restore passed sums
  Sp â† {tâ†âŒŠğ•©Ã·base â‹„ âŸ¨ğ•©-baseÃ—t, tâŸ©}     # Split into top and bottom
  Trim AddâŸœ(0âŠ¸âˆ¾)Â´ (Sp s) âˆ¾ {âˆ§Â´ğ•©<base?â‹ˆğ•©; <âŠ¸âˆ¾âŸœğ•ŠÂ´Spğ•©} o
}

_compare â‡ {
  Full â† 0âŠ¸â‰¤â—¶âŸ¨ğ”½Ëœ,âŠ‘âŸœğ•¨ğ”½âŠ‘âŸœğ•©âŸ© Â· -âŸœ1 _while_ (0âŠ¸â‰¤â—¶âŸ¨0,âŠ‘âŸœğ•¨=âŠ‘âŸœğ•©âŸ©) -âŸœ1
  ğ•¨ =â—¶ğ”½â€¿Fullâ—‹â‰  ğ•©
}

Neg â‡ (!0=â‰ )âŠ¸âŠ¢
Signum â‡ Ã—âˆ˜â‰ 
Abs â‡ Conj â‡ âŠ¢

Fact â‡ { ğ•©â‰¤1? âŸ¨1âŸ©; ğ•¨ğ•Šn:
  Prod â† {2â‰¤lâ†â‰ ğ•© ? (âŒŠlÃ·2)(â†‘Mulâ—‹ğ•Šâ†“)ğ•© ; From Ã—Â´ğ•©} # Recurse to keep intermediates small
  Pri â† {/(2â‰¤â†•ğ•©){ğ•©>0âŒ¾(ğ•¨âŠ¸âŠ‘)ğ•©â‰ âŠ¸â¥Šğ•¨â†‘1}âŸâŠ‘Â´âŒ½â†•âŒˆâˆšğ•©}     # Primes <ğ•©
  p â† ğ•¨ PriâŠ˜(â‰¤/âŠ£) n+1                           # (save them in ğ•¨)
  s â† Prod 1âŠ¸<âŠ¸/ {ğ•Šp:pâ‹†+Â´2|{ğ•Š0:â†•0;ğ•ŠâŠ¸âˆ¾âŒŠğ•©Ã·p}n}Â¨ p # Swinging factorial
  s Mul MulËœ p ğ•Š âŒŠnÃ·2
}âˆ˜âŠ¢
