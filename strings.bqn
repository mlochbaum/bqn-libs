âŸ¨
  _join
  Split, Locate
  ReplaceAll
  _template
  tab,lf,cr,crlf, JoinLines
  Trim
  CEscape
  ToBytes, FromBytes
  ToBase64, FromBase64
  ToNats, ToNums
  Lcs, LcsLen, Levenshtein
âŸ©â‡

# Whitespace characters: tab, linefeed, carriage return
tabâ€¿lfâ€¿cr â† @+9â€¿10â€¿13
crlf â† crâ€¿lf  # Windows-style line separator

# Convert lines to lf-separated string, including trailing lf
JoinLines â† âˆ¾ âˆ¾âŸœlfÂ¨

# "sep"_join is like âˆ¾ but inserts "sep" between any joined strings
_join â† {âˆ¾1â†“â¥Š(<ğ•—)â‰Ë˜ğ•© ; âˆ¾ğ•¨â€¿ğ•—â€¿ğ•©}

# Remove leading (âˆ§`) and trailing (âˆ§`âŒ¾âŒ½) spaces
Trim â† ((âˆ¨` âˆ§ âˆ¨`âŒ¾âŒ½) ' 'âŠ¸â‰ )âŠ¸/

# Given strings â¥Šğ•¨ and ğ•©, return âŸ¨start_mask, keep_maskâŸ© for split
MarkSplit â† (2âŒŠâ‰ âˆ˜âŠ£)â—¶{ğ•¤
  ! "Split: ğ•¨ can't be empty"
}â€¿{
  â‹ˆâŸœÂ¬ (âŸ¨âŸ©â¥Šğ•¨)=ğ•©
}â€¿{
  c â† (â‰ ğ•¨)-1                  # ğ•¨â·ğ•©      011000010011    (câ†3)
  i â† 0 (-âŸœ1âŒˆcÃ—<)` (â‰ ğ•©)â†‘ğ•¨â·ğ•©   # i        032100032103210
  âŸ¨c=i,1âŠ¸Â»âŠ¸âˆ§0=iâŸ©              # 1âŠ¸Â»âŠ¸âˆ§0=i 100001100000000
}

# Return mask of non-overlapping positions in ğ•© where ğ•¨ is found
# Like ğ•¨â·ğ•© but same length as ğ•© and suppressing overlaps (leftmost wins)
Locate â† âŠ‘ MarkSplit

# Split string ğ•© on occurrences of separator ğ•¨, removing the separators
Split â† (0<â‰ âˆ˜âŠ¢)â—¶âŸ¨
  â‹ˆâŠ¢
  (1+`âŠ¢)âŠ¸((1-ËœÃ—)âˆ¾Â¯1âŠâŠ£)Â´âˆ˜MarkSplitâŸ(0<â‰ âˆ˜âŠ¢) âŠ” âŠ¢
âŸ©

# Replace each instance of a string in old with the corresponding
# string in new.
# Instances are non-overlapping, and earlier ones take precedence.
ReplaceAll â† { âŸ¨old,newâŸ© ğ•Š str:
  ! (â‰ new) â‰¡ l â† â‰ old
  "ReplaceAll: Can't replace empty" ! âˆ§Â´0<â‰ Â¨old
  match â† 1-Ëœ (l+1)|âŒŠÂ´ (â†•âŠ¸-l) Ã— old (1<â‰ âˆ˜âŠ£)â—¶âŸ¨âŠ‘âŠ¸=,â‰ âˆ˜âŠ¢â†‘â·âŸ©Â¨ <str
  cont â† (-âŸœ1âŒˆâ‰¤âŸœ1Ã—âŠ¢)` match âŠ (â‰ Â¨old)âˆ¾0
  keep â† â‹ˆâŸœ(âŠâŸœstr) / 0=cont
  insert â† (newâŠËœâŠâŸœmatch)âŠ¸(â‰ Â¨âŠ¸/â‹ˆâˆ¾âˆ˜âŠ£) / (0âŠ¸<âˆ§Â»âŠ¸â‰¤) cont
  â‹âŠ¸âŠÂ´ keep âˆ¾Â¨ insert
}

# Replace instances of ğ•— in ğ•¨ with successive elements of ğ•©
_template â† { âˆ¾ 1 (â†‘âˆ¾Â·â¥Šğ•©â‰Ë˜â†“) ğ•— Split ğ•¨ }

# String escaping
âŸ¨CEscapeâŸ© â† {
  basic â† """'?\abefnrtv"
  comp  â† (hexâ†"uUx")âˆ¾(octâ†'0'+â†•8)
  in  â† basicâˆ¾comp
  out â† âˆ¾âŸ¨4â†‘in, @+7â€¿8â€¿27â€¿12â€¿10â€¿13â€¿9â€¿11, @Â¨compâŸ©
  c_hex â† (â‰ hex) + c_basic â† â‰ basic
  c_fix â† 2 + c_basic
  len â† âˆ¾âŸ¨0Â¨basic, 4â€¿8â€¿âˆ, 3Â¨octâŸ©
  CEscape â‡ { ğ•Šs:
    m â† Â» bs â† <`s='\'
    max â† âŒˆÂ´ i â† in âŠ m/s
    "Unsupported escape sequence" ! max<â‰ in
    keep â† Â¬bs
    o â† iâŠout
    { max < c_basic ?@; # If compound escapes
      f â† i â‰¥ c_basic
      ic â† f/i â‹„  im â† f//m
      d â† ic<c_hex
      l â† (icâŠlen) âŒŠ (1+d) -Ëœ (â‰ m)(Â«-âŠ¢)im
      ld â† l/d
      sel â† s âŠËœ ia â† (l/im+d)+liâ†âŠ’/l
      dig â† ("Aa"-'0')âŠ¸(âŠ¢+(0âˆ¾10-âŠ£)âŠËœâ‹)âŒ¾(ldâŠ¸/) '0'-Ëœsel
      isdig â† (0âŠ¸â‰¤ âˆ§ <âŸœ(8Ã—1+ld)) dig
      lm â† 0=li
      nâ€¿ku â† { max < c_fix ?
        "Numeric code ends early" ! âˆ§Â´ isdig
        âŸ¨ {0 16âŠ¸Ã—âŠ¸+ËœÂ´âŒ½ğ•©}Â¨(Â¯1+`lm)âŠ”dig , 0Â¨ âŸ©
      ; # If variable-length escapes
        k â† lm >â—‹(âŒˆ`(1+â†•âˆ˜â‰ )âŠ¸Ã—)âŸœÂ¬ isdig
        bm â† l/ic<c_fix
        "Numeric code ends early" ! âˆ§Â´ bmâ‰¤k
        "\x must be followed by at least one digit" ! âˆ§Â´ lmâ‰¤k
        âŸ¨ (8Ã—1+d){0ğ•¨âŠ¸Ã—âŠ¸+ËœÂ´âŒ½ğ•©}Â¨(1-ËœkÃ—+`lm)âŠ”dig , kâ‰¤ld<lm âŸ©
      }
      keep kuâŒ¾(iaâŠ¸âŠ)â†©
      o (@+n)âŒ¾(fâŠ¸/)â†©
    }
    keep / oâŒ¾(mâŠ¸/) s
  }
}

# UTF-8 conversions
ToBytes â† âˆ¾ (2â‹†7)âŠ¸(âŠ£+(2â‹†6){ğ•¨ â‰¤â—¶âŸ¨â¥ŠâŠ¢-2Ã—-âŸœğ•— â‹„ ğ•—(|âˆ¾Ëœ(2Ã·ËœâŒŠâŸœğ•¨)ğ•ŠâŒŠâˆ˜Ã·Ëœ)âŠ¢âŸ© ğ•©}Â¨)âŒ¾(-âŸœ@)
FromBytes â† (+`2â‹†7-â†•5){
  tâ†ğ•—â‹ğ•©
  !((/Â¬âŸ(<âŸœ2)Â¨)â‰¡Â·âŒˆ`1âŠ¸â‰ Ã—â†•âˆ˜â‰ )t
  !(â†•âˆ˜â‰ â‰¡Â·âŠ’âŠ¸+âˆ˜/Â¬âŸ(<âŸœ2)Â¨)t
  râ†(2â‹†6)âŠ¸Ã—âŠ¸+ËœÂ´âˆ˜âŒ½Â¨(Â¯1+`tâ‰ 1)âŠ”ğ•©-tâŠÂ»ğ•—
  r
}âŒ¾(-âŸœ@)

# Base64
b64 â† âˆ¾ (âŠ£+â†•âˆ˜Â¬Ëœ)Â¨ËË˜ âˆ˜â€¿2â¥Š"AZaz09++//"
K64 â† â¥ŠÂ¨âŸœ(4â‹†âŸ¨1+â†•3,2-â†•3âŸ©) # Bytes split as 6/2-4/4-2/6
ToBase64 â† {ğ•Šâ¼ğ•©: FromBase64ğ•©;
  lâ†â‰ iâ†ğ•©-@ â‹„ "Base64 input must consist of bytes (<@+256)" ! âˆ§Â´256>i
  fâ†lâ¥Š1+0=â†•3
  Mâ†((+Â´f)â¥Š0<â†•4) Ã— fâŠ¸/
  aâ€¿bâ†K64 l
  vâ†a (âŒŠâˆ˜Ã·Ëœ Â«âŠ¸+â—‹M bÃ—|) i
  (vâŠb64)âˆ¾(3|-l)â¥Š'='
}
FromBase64 â† {ğ•Šâ¼ğ•©: ToBase64ğ•©;
  pâ†64>iâ†b64âŠğ•©
  "Invalid Base64 characters" ! âˆ§`âŠ¸â‰¡ p
  iâ†‘Ëœâ†©lâ†+Â´p
  aâ€¿bâ†K64 +Â´fâ†lâ¥Š0<â†•4
  @ + (256|aÃ—(Â«f)/i) + bâŒŠâˆ˜Ã·Ëœf/i
}

# Parse numbers from a string, treating non-numeric characters as
# separators
# Natural numbers recognize digits only
NN â† (>âŸœÂ«0âŠ¸â‰¤) / 0(0âŠ¸â‰¤Ã—Ã—âŸœ10âŠ¸+)`âŠ¢
ToNats â† { NN 10âŠ¸â‰¤âŠ¸(Â¬âŠ¸Ã—-âŠ£) ğ•©-'0' }

# General numbers recognize digits and eE.Â¯-Ï€âˆ (mild extension of BQN)
ToNums â† {
  Tâ†âŒˆ`Ã— â‹„ I1Tâ†(1+â†•âˆ˜â‰ )âŠ¸T
  cdâ†â‰ digâ†('0'+â†•10)âˆ¾"Ï€âˆ" â‹„ valâ†(â†•10)âˆ¾Ï€â€¿1â€¿Â¯1 # âˆ as 1 to avoid âˆÃ—0
  eâ€¿dâ€¿nâ€¿pâ€¿iâ†"e.Â¯Ï€âˆ"=<ğ•© â‹„ eâ€¿nâˆ¨â†©"E-"=<ğ•©
  mâ†dâˆ¨cd>jâ†digâŠğ•©
  sâ†dâˆ¨câ†eâˆ¨zâ†(âˆ§`âŒ¾âŒ½<Â»âŠ¸<)zzâ†Â¬eâˆ¨nâˆ¨m
  "Negative sign in the middle of a number"! âˆ§Â´nâ‰¤1Â»c
  "Portion of a number is empty"! âˆ§Â´Â¬(1Â«s)âˆ§nâˆ¨s
  "Ill-formed decimal or exponent use"! âˆ§Â´(0âŠ¸=âˆ¨Â»âŠ¸<)s/d+2Ã—e
  "Ï€ and âˆ must occur alone"! âˆ§Â´(pâˆ¨i)â‰¤1(Â»âˆ§(pâˆ§Â«e)âˆ¨Â«)zzâˆ¨n>Â»e
  fâ†(17â‰¥Â¬(âŠ¢-T)+`)âŠ¸âˆ§gâ†(Â«â‰¤(d<jâ‰ 0)>â—‹I1TÂ¬)âŠ¸âˆ§m   # No leading 0s; max 17 digits
  vsâ†1â€¿Â¯1âŠËœ(râ†>âŸœÂ»m)/Â»n                      # Negate if Â¯
  vâ†vsÃ—NN valâŠËœ(Â¬d)/(cdÃ—Â¬f)âŒˆj               # Numeric valuesâ€”mantissas and exponents
  vmâ†c/â—‹(1âŒ¾âŠ‘)z                              # Mask of mantissas in v
  dpâ†vm/f(--Â»âŠ¸-(<Ã—âŠ¢)âŠâŸœ(I1TÂ«d)âŠ¸-)â—‹(/>âŸœÂ«)g    # Decimal position
  qâ†10â‹†|eeâ†dp-Ëœvm/Â«vÃ—Â¬vm                    # Power of 10
  qÃ·ËœâŒ¾((0>ee)âŠ¸/)qÃ—âŒ¾((0<ee)âŠ¸/)vm/vÃ—(r/i)âŠ1â€¿âˆ # Correct âˆ then Ã—10â‹†ee
}

# String similarity
LcsLen â† âˆ§â—‹(0<â‰ )â—¶âŸ¨0, Â¯1 âŠ‘ 0Â¨âˆ˜âŠ¢ {ğ•©âŒˆâŒˆ`ğ•¨+Â»ğ•©}Ë =âŒœâŸœâŒ½âŸ©
Lcs â† Â¯1 âŠ‘ "" <âŠ¸âˆ¾ ""Â¨âˆ˜âŠ¢ âŠ£âŸ(>â—‹â‰ ){ğ•©ğ”½Â¨ğ”½`ğ•¨âˆ¾Â¨""<âŠ¸Â»ğ•©}Ë (=âŒœâ¥ŠÂ¨âŠ£)âŸœâŒ½
Levenshtein â† Â¯1âŠ‘{ğ•¨((1âŠ¸+â¥Š+)â—‹â‰ (âŒŠ`âŠ¢âŒŠâŠâŠ¸Â»âˆ˜âŠ¢-0âˆ¾1+=âŸœğ•©)Â´âŒ½âˆ˜âŠ£)ğ•©}
