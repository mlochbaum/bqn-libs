âŸ¨
  _join
  Split, Locate
  ReplaceAll
  _template
  tab,lf,cr,crlf, JoinLines
  Trim
  ToBytes, FromBytes
âŸ©â‡

# Whitespace characters: tab, linefeed, carriage return
tabâ€¿lfâ€¿cr â† @+9â€¿10â€¿13
crlf â† crâ€¿lf  # Windows-style line separator

# Convert lines to lf-separated string, including trailing lf
JoinLines â† âˆ¾ âˆ¾âŸœlfÂ¨

# "sep"_join is like âˆ¾ but inserts "sep" between any joined strings
_join â† {âˆ¾1â†“â¥Š(<ğ•—)â‰Ë˜ğ•© ; âˆ¾ğ•¨â€¿ğ•—â€¿ğ•©}

# Remove leading (âˆ§`) and trailing (âˆ§`âŒ¾âŒ½) spaces
Trim â† ((âˆ¨` âˆ§ âˆ¨`âŒ¾âŒ½) ' 'âŠ¸â‰ )âŠ¸/

# Given strings â¥Šğ•¨ and ğ•©, return âŸ¨start_mask, keep_maskâŸ© for split
MarkSplit â† (2âŒŠâ‰ âˆ˜âŠ£)â—¶{ğ•¤
  ! "Split: ğ•¨ can't be empty"
}â€¿{
  â‰â—‹<âŸœÂ¬ (âŸ¨âŸ©â¥Šğ•¨)=ğ•©
}â€¿{
  c â† (â‰ ğ•¨)-1                  # ğ•¨â·ğ•©      011000010011    (câ†3)
  i â† 0 (-âŸœ1âŒˆcÃ—<)` (â‰ ğ•©)â†‘ğ•¨â·ğ•©   # i        032100032103210
  âŸ¨c=i,1âŠ¸Â»âŠ¸âˆ§0=iâŸ©              # 1âŠ¸Â»âŠ¸âˆ§0=i 100001100000000
}

# Return mask of non-overlapping positions in ğ•© where ğ•¨ is found
# Like ğ•¨â·ğ•© but same length as ğ•© and suppressing overlaps (leftmost wins)
Locate â† âŠ‘ MarkSplit

# Split string ğ•© on occurrences of separator ğ•¨, removing the separators
Split â† (0<â‰ âˆ˜âŠ¢)â—¶âŸ¨
  â‰â—‹<âŠ¢
  (1+`âŠ¢)âŠ¸((1-ËœÃ—)âˆ¾Â¯1âŠâŠ£)Â´âˆ˜MarkSplitâŸ(0<â‰ âˆ˜âŠ¢) âŠ” âŠ¢
âŸ©

# Replace each instance of a string in old with the corresponding
# string in new.
# Instances are non-overlapping, and earlier ones take precedence.
ReplaceAll â† { âŸ¨old,newâŸ© ğ•Š str:
  ! (â‰ new) â‰¡ l â† â‰ old
  match â† 1-Ëœ (l+1)|âŒŠÂ´ (â†•âŠ¸-l) Ã— old LocateÂ¨ <str
  cont â† (-âŸœ1âŒˆâ‰¤âŸœ1Ã—âŠ¢)` match âŠ (â‰ Â¨old)âˆ¾0
  keep â† â‰â—‹<âŸœ(âŠâŸœstr) / 0=cont
  insert â† (newâŠËœâŠâŸœmatch)âŠ¸(â‰ Â¨âŠ¸/â‰â—‹<âˆ¾âˆ˜âŠ£) / (0âŠ¸<âˆ§Â»âŠ¸â‰¤) cont
  â‹âŠ¸âŠÂ´ keep âˆ¾Â¨ insert
}

# Replace instances of ğ•— in ğ•¨ with successive elements of ğ•©
_template â† { âˆ¾ 1 (â†‘âˆ¾Â·â¥Šğ•©â‰Ë˜â†“) ğ•— Split ğ•¨ }

ToBytes â† âˆ¾ (2â‹†7)âŠ¸(âŠ£+(2â‹†6){ğ•¨ â‰¤â—¶âŸ¨â¥ŠâŠ¢-2Ã—-âŸœğ•— â‹„ ğ•—(|âˆ¾Ëœ(2Ã·ËœâŒŠâŸœğ•¨)ğ•ŠâŒŠâˆ˜Ã·Ëœ)âŠ¢âŸ© ğ•©}Â¨)âŒ¾(-âŸœ@)
FromBytes â† (+`2â‹†7-â†•5){
  tâ†ğ•—â‹ğ•©
  !((/Â¬âŸ(<âŸœ2)Â¨)â‰¡Â·âŒˆ`1âŠ¸â‰ Ã—â†•âˆ˜â‰ )t
  !(â†•âˆ˜â‰ â‰¡Â·âŠ’âŠ¸+âˆ˜/Â¬âŸ(<âŸœ2)Â¨)t
  râ†(2â‹†6)âŠ¸Ã—âŠ¸+ËœÂ´âˆ˜âŒ½Â¨(Â¯1+`tâ‰ 1)âŠ”ğ•©-tâŠÂ»ğ•—
  r
}âŒ¾(-âŸœ@)
