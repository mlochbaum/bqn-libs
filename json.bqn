# JSON: JavaScript Object Notation
âŸ¨
  Parse  # JSON string to BQN
âŸ©â‡

âŸ¨ConstsâŸ© â† {
  val â† <Â¨ name â† "true"â€¿"false"â€¿"null"
  Consts â‡ {
    i â† name âŠ ğ•©
    "Unknown constant" ! âˆ§Â´ i<â‰ name
    i âŠ val
  }
}
âŸ¨UnEscapeâŸ© â† {
  in â† """\/bfrnt"
  out â† (3â†‘in)âˆ¾@+8â€¿12â€¿13â€¿10â€¿9
  diff â† (out-in) âˆ¾ 0
  UnEscape â‡ { ğ•© + ğ•¨ Ã— (inâŠğ•©) âŠ diff }
}
wsâ†@+9â€¿10â€¿13â€¿32 # whitespace

# JSON to âŸ¨tokens, constants, numbers, stringsâŸ©
# Tokens are characters {}[],: and a constant, 0 number, " string
# Values correspond to a, 0, and " in order
Tokenizeâ†{
  # Strings
  e â† Â»eo â† <`'\'=ğ•©
  s â† â‰ `q â† e<'"'=ğ•©
  "Unclosed quote" ! Â¬Â¯1âŠ‘s
  "Backslash outside string" ! âˆ§Â´sâ‰¥e
  sg â† 1-Ëœ(s>qâˆ¨eo)Ã—+`sâˆ§q            # Start at sâˆ§q; exclude q and eo
  str â† sg âŠ” e UnEscape ğ•©           # Strings

  # Numbers and constants
  wâ†Â»âŠ¸<lâ†Â¬sâˆ¨ğ•©âˆŠ"""{}[],:"âˆ¾ws         # Word chars l, start w
  nâ†lâˆ§(+`w)âŠ0âˆ¾('-'âˆ¾'0'+â†•10)âˆŠËœw/ğ•©    # Number starts
  kâ†n<w                             # Constant starts
  cns â† Consts (1-Ëœ(n<l)Ã—+`k)âŠ”ğ•©     # Constants
  num â† â€¢ParseFloatÂ¨ (1-ËœnÃ—+`nâˆ§w)âŠ”ğ•© # Numbers

  # Tokenize
  f â† Â¬(ğ•©âˆŠws)âˆ¨(w<l)âˆ¨s               # First characters of tokens
  tok â† '0'Â¨âŒ¾((f/n)âŠ¸/) 'a'Â¨âŒ¾((f/k)âŠ¸/) f/ğ•©
  âŸ¨tok, cns, num, strâŸ©
}

Parse â† {
  tâ€¿cnsâ€¿numâ€¿strk â† Tokenize ğ•©

  # Validate (incomplete)
  q â† '"'=t
  c â† ':'=t
  "Object keys must be strings" ! âˆ§Â´(Â»q)â‰¥c
  g â† â‹+`(coâ†tâˆŠ"[{")-ccâ†tâˆŠ"]}"      # Bracket depth ordering indices
  u â† gâŠt
  r â† +` s â† uâˆŠ"[{"
  o â† s/'{'=u                       # Container is object
  "Improper , or : usage" ! (â‰¢â¥Š0â€¿1Ë™)âŠ¸â‰¡ sâˆ¨uâˆŠ",:"
  RunLen â† (1+â†•âˆ˜â‰ )(âŠ£-âŒˆ`âˆ˜Ã—)Â¬
  p â† 4 | RunLen r âŠ 0âˆ¾o            # Position within object
  "Improper : usage" ! (u=':') â‰¡ 3=p
  "Object ends cefore key-value pair completed" ! Â¬âˆ¨Â´sâˆ§Â»0â‰ p

  # Keys
  l â† (â‹g) âŠ r                      # Container index
  j â† +`âŠ¸Ã— o                        # Object index (start at 1; 0 if list)
  keys â† (q/(Â«c)Ã—lâŠ0âˆ¾j) âŠ” strk
  str â† âŠ‘1â†‘keys

  # Build collections
  nv â† â‰  vals â† âˆ¾cnsâ€¿numâ€¿str        # Initial set of values
  f â† Â¬(Â«âŠ¸âˆ¨c)âˆ¨coâˆ¨','=t              # Filter for just values a0"]}
  viâ† â‹â‹(f/'0'=t)+(2Ã—f/q)+3Ã—f/cc    # Value indices
  i â† vi âŠ (â†•nv) âˆ¾ nv+â‰ âŠ¸-cc/Â»l      # Adjust for collection ordering
  j {valsâˆ¾â†©<ğ•¨âŠ‘âŸœkeysâŠ¸â‰âŸ(0<âŠ£)ğ•©âŠvalsâ‹„@}Â¨â—‹âŒ½ (1-Ëœf/l)âŠ”i
  Â¯1âŠ‘vals
}
