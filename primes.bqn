âŸ¨
  PrimesTo
  PrimesIn, SieveSegment
  Factor
âŸ©â‡

# Wheel factorization
MakeWheel â† {
  len â‡ Ã—Â´primes â‡ ğ•©     # Primes in wheel and wheel length
  mask â‡ âˆ§Ë0â‰ primes|âŒœâ†•len
  numc â‡ â‰  coprime â‡ /mask

  # Get prime mask on segment [start,end) with prime divisors pd
  # Assumes pd doesn't intersect primes, or [start,end)
  Sieve â‡ {pd ğ•Š startâ€¿end:
    wâ†coprime,wnâ†numc,wlâ†len
    bcâ€¿ep â† wl (âŒŠâˆ˜Ã·Ëœ â‰â—‹< wâ‹|) (ğ•©-1)Ã·âŒœpd
    _uâ†{âŸ¨âŠğ•©,ğ•—+-ËœËğ•©âŸ©}
    bsâ€¿brâ† 1 _u bc
    fsâ€¿r â† wn _u (1(âŠ¢â‰Â«)âˆŠ/br) Ã— brâŠ¸/Ë˜ ep-0â€¿wn
    i â† (r/br/pd) Ã— (r/wlÃ—br(/+âŠ’âˆ˜/âˆ˜âŠ£)bs) + wâŠËœ(âŠ’/r)+r/fs

    0Â¨âŒ¾((i-start)âŠ¸âŠ) (end-start)â¥ŠstartâŒ½mask
  }
}

# Prime state
next â† 11
âŸ¨SieveâŸ© â† wheel â† MakeWheel 2â€¿3â€¿5â€¿7
wlen â† â‰  wheel.primes
primes â† wheel.primes
Extend â† {
  E â† {
    next â†© âŒˆ ğ•© âŒŠ (1e7âŠ¸+ âŒŠ Ã—Ëœ) oldâ†next
    primes âˆ¾â†© old + / (wlenâ†“primes) Sieve oldâ€¿next
    ğ•ŠâŸ(nextâŠ¸<) ğ•©
  }
  next Eâˆ˜(2âŠ¸Ã—âŠ¸âŒˆ)âŸ< ğ•©
}

CheckNum  â† "Argument must be a non-negative number" ! (1=â€¢Type)â—¶âŸ¨0,0âŠ¸â‰¤âŸ©
CheckNat  â† "Argument must be a natural number" ! (1=â€¢Type)â—¶âŸ¨0,|âˆ˜âŒŠâŠ¸=âŸ©

PrimesTo â‡ {
  CheckNum ğ•©
  Extend ğ•©
  primes (â‹â†‘âŠ£) ğ•©
}

_getSegment â† {ind _ğ•£:
  PRange â† { primes (âŠ£âŠËœÂ·(âŠ£+â†•âˆ˜-Ëœ)Â´â‹) ğ•©-1 }
  sn â† {âŠ‘âˆ˜âŠ¢+/âˆ˜ğ•}âŸğ•— sieve
  pr â† {-ËœÂ´ â†‘ Â·/â¼ğ•-âŠ‘}âŸ(Â¬ğ•—) prange
  S â† {ğ•Š sâ€¿e:
    n â† nextâŒŠe
    (PR sâ€¿n) âˆ¾ <Â´â—¶âŸ¨âŸ©â€¿SN nâ€¿e
  }
  # IsPrimeÂ¨âŠ¸(ğ•—â—¶âŠ£â€¿/) start(âŠ£+â†•âˆ˜-Ëœ)end
  {ğ•Š startâ€¿end:
    CheckNatÂ¨ ğ•©
    "Range must be ordered" ! â‰¤Â´ğ•©
    (wlen â†“ PrimesTo âˆšend-1) (nextâ‰¤start)â—¶Sâ€¿SN ğ•©
  }
}
SieveSegment â‡ 0 _getSegment  # IsPrimeÂ¨   (âŠ£+â†•âˆ˜-Ëœ)Â´
PrimesIn     â‡ 1 _getSegment  # IsPrimeÂ¨âŠ¸/ (âŠ£+â†•âˆ˜-Ëœ)Â´

Factor â‡ {
  CheckNat ğ•©
  âˆ§ ğ•© {(0<â‰ âˆ˜âŠ¢)â—¶âŸ¨â¥ŠâŠ£,âŠ¢âˆ¾ğ•ŠâŸ©âŸ(>âŸœ1)ËœâŸœ(ğ•¨Ã·Ã—Â´)ğ•©/Ëœ0=ğ•©|ğ•¨} PrimesTo âˆšğ•©
}âš‡0

# Prime factors and exponents
FactorExponents â‡ (/â‰ âŸœÂ«)âŠ¸(âŠ â‰ -âŸœ(Â¯1âŠ¸Â»)âˆ˜âŠ£) âˆ˜ Factor âš‡0
