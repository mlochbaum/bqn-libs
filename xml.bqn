# XML: Extensible Markup Language
âŸ¨
  Parse   # XML string to BQN
âŸ©â‡

# XML, and tag contents, are parsed to give a list of objects.
# Objects may be tags, special tags or text.
# Text is represented as an enclosed string.
# A special tag is also an enclosed string but starts and ends with <>.
# Tags are a list of:
# - Tag name
# - Attributes, as namesâ‰values
# - (unless void) Contents: list of text and tags

# The following open/close pairs form special tags:
# <!--       -->
# <![CDATA[  ]]>
# <!           >
# <?           >

ws â† @+9â€¿10â€¿13â€¿32                       # Tab, LF, CR, space
namestart â† âˆ§(â¥Š"Aa"+âŒœâ†•26)âˆ¾"_:"
namechar  â† âˆ§namestartâˆ¾('0'+â†•10)âˆ¾".-"   # (ASCII only)

E â† +`âŠ¸Ã—âŸœÂ¬-âŠ¢
Seâ†â‰ (>/âŠ¢)âˆ¾âŸœâ‰ {(âŠËœğ•¨)ğ•ŠâŸ(â‰ â—‹(Â¯1âŠ¸âŠ‘))ğ•©âˆ¾ğ•©âŠğ•¨}âŸ¨0âŸ©Ë™
Traceâ†{ğ•¨(Seâˆ˜â‹âŠâ‰Ë˜)â—‹((â‹ğ•¨)âŠ¸âŠ)ğ•©}â—‹âˆ¾

Parse â† {
  # Resolve special tags not closed by plain >
  Tr â† (â‰ ğ•©)â†‘Â·/â¼Â·â¥ŠTrace
  [sm,sn] â† 1â€¿Â¯1(Ã—âŸœ(â‰ ğ•©)â†‘âŠ¢â·ğ•©Ë™)Â¨["<!--"â€¿"<![CDATA[","-->"â€¿"]]>"]
  ex â† â‰ `âŠ¸>sbâ†TrÂ´ âŸ¨/Â¨sm, sm(0âˆ¾+`)âŠ¸(-âŸœÂ»âˆ˜âŠËœ/âŠ¢)âŸœ(/âˆ¾âŸœ1)Â¨snâŸ©
  # And quotes
  eq â† â‰ `qbâ†TrË Â¯1â€¿1â†“âŒœ(/ex<ğ•©âŠ¸=)Â¨"'"""
  # Extract strings and group into tags
  esâ€¿ee â† ((exâˆ¨eq)<ğ•©âŠ¸=)Â¨"<>"         # Tag start and end including special
  "Ill-formed tag" ! {((es/ğ•©)âˆ§â—‹(âˆ§Â´)Â¬ee/ğ•©) âˆ§ 0=âŠ¢Â´ğ•©} â‰ `esâˆ¨ee
  ts â† (sbâˆ¨Â«ğ•©âˆŠ"!?")<es               # Tag start < (non-special)
  te â† eeâˆ§tsâŠËœâŒˆ`esÃ—â†•â‰ ğ•©               # Tag end   >
  os â† tsâˆ¨Â»te
  td â† (Â»âŠ¸âˆ§eq) < â‰ ` tb â† tsâˆ¨te
  tw â† tdâˆ§ğ•©âˆŠwsâˆ¾"=" â‹„ sl â† tdâˆ§ğ•©='/'
  rg â† (rbâ†osâˆ¨tdâˆ§sl<Â»âŠ¸>tw) E qbâˆ¨tbâˆ¨twâˆ¨sl
  pd â† (0âˆ¾rb/tdÃ—+`ts) âŠ” rgâŠ”ğ•©
  pt â† (2Ã—tsÂ»âŠ¸/sl)-ËœÂ¬teÂ«âŠ¸/sl         # Tag type: Â¯1 close, 0 void, 1 open
  ! âˆ§Â´â‰¡â—‹âŠ‘Â¨Ë pd âŠËœ 1+(â‹âŠâŸœ(+`pt))âŠ¸âŠâˆ˜/Ë˜ Â¯1â€¿1=âŒœpt  # Tag matching
  opâ€¿v â† (âŠ‘â‹ˆÂ·â‰âˆ˜â€¿2â¥Š1â†“âŠ¢)Â¨Â¨ âŒ½ (ptâˆ¾2) âŠ” 1â†“pd  # Build tag data
  # Build result
  tag â† os/ts
  tt â† ptâŒ¾(tagâŠ¸/) tag
  [c,n,o]â†Â¯1â€¿0â€¿1=âŒœtt
  l â† +`âŒ¾((â‹+`tt)âŠ¸âŠ) o               # Parent index
  nvâ† â‰ vals â† (<Â¨1â†“âŠ‘pd) âˆ¾ v          # Initial set of values
  viâ† â‹â‹(fâ†Â¬o)/c                     # Value indices
  i â† vi âŠ (â‹â‹n/tag) âˆ¾ nv+â‰ âŠ¸-c/Â»l    # Adjust for collection ordering
  (âŸ¨âŸ©â‹ˆâŠ¸âˆ¾op) {valsâˆ¾â†©âŸ¨ğ•¨âˆ¾âŸ¨ğ•©âŠvalsâŸ©âŸ©â‹„@}Â¨â—‹âŒ½ ((1+Â´c)âˆ¾Ëœf/l)âŠ”i
  âŠ‘Â¯1âŠ‘vals
}
