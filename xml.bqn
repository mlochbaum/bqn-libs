# XML: Extensible Markup Language
âŸ¨
  Parse   # XML string to BQN
âŸ©â‡

# XML, and tag contents, are parsed to give a list of objects.
# Objects may be tags, special tags or text.
# Text is represented as an enclosed string.
# A special tag is also an enclosed string but starts and ends with <>.
# Tags are a list of:
# - Tag name
# - Attributes, as namesâ‰values
# - (unless void) Contents: list of text and tags

# The following open/close pairs form special tags:
# <!--       -->
# <![CDATA[  ]]>
# <!           >
# <?           >

ws â† @+9â€¿10â€¿13â€¿32                       # Tab, LF, CR, space
namestart â† âˆ§(â¥Š"Aa"+âŒœâ†•26)âˆ¾"_:"
namechar  â† âˆ§namestartâˆ¾('0'+â†•10)âˆ¾".-"   # (ASCII only)

Seâ†â‰ (>/âŠ¢)âˆ¾âŸœâ‰ {(âŠËœğ•¨)ğ•ŠâŸ(â‰ â—‹(Â¯1âŠ¸âŠ‘))ğ•©âˆ¾ğ•©âŠğ•¨}âŸ¨0âŸ©Ë™
Traceâ†{ğ•¨(Seâˆ˜â‹âŠâ‰Ë˜)â—‹((â‹ğ•¨)âŠ¸âŠ)ğ•©}â—‹âˆ¾

# Format error with message ğ•¨ at locations ğ•© in ğ•—
_fmtErr â† { msg src _ğ•£ pos:
  lf â† @+10
  s â† 0âˆ¾1+ bâ†/src=lf                # Line start and break positions
  l â† (1â†“s) â‹ pos                   # Error line numbers
  c â† pos - lâŠs                     # Error column numbers
  d â† âŠ‘l                            # First line only
  1â†“âˆ¾lfâŠ¸âˆ¾Â¨ âŸ¨
    msg
    (dâŠ‘s)â†“(dâŠ‘bâˆ¾â‰ src)â†‘src            # Display first line
    " ^" âŠËœ /â¼ (d=l)/c              # And carets under errors
  âŸ©âˆ¾{
    n â† â‰  a â† dâŠ¸â‰ âŠ¸/l                # 1-indexed numbers of other lines
    0<n ? â‹ˆ((-1=n)â†“"Also lines")âˆ¾1â†“âˆ¾â¥Š(<", ")â‰Ë˜â€¢ReprÂ¨1+a
    ; âŸ¨âŸ©
  }
}

Parse â† {
  FE â† ğ•©_fmtErr â‹„ _err â† {(! ğ•— FE /)âŸ(âˆ¨Â´)}
  # Resolve special tags not closed by plain >
  Tr â† (â‰ ğ•©)â†‘Â·/â¼Â·â¥ŠTrace
  Match â† (0âˆ¾+`)âŠ¸(-âŸœÂ»âˆ˜âŠËœ/âŠ¢)âŸœ(/âˆ¾â‰ )
  [sm,sn] â† 1â€¿Â¯1(Ã—âŸœ(â‰ ğ•©)â†‘âŠ¢â·ğ•©Ë™)Â¨["<!--"â€¿"<![CDATA[","-->"â€¿"]]>"]
  ex â† â‰ `âŠ¸> sb â† TrÂ´ âŸ¨/Â¨sm, sm MatchÂ¨ snâŸ©
  # And quotes/brackets
  # Treat >< as a kind of quote since quotes inside are just text
  qsâ€¿qdâ€¿eeâ€¿es â† (ex<ğ•©âŠ¸=)Â¨"'""><"
  qa â† TrË (Â¯1â€¿1â†“âŒœ/Â¨qsâ€¿qd) âˆ¾Ë˜ âŸ¨/ee, ee Match esâŸ©
  eq â† â‰ ` qb â† qa âˆ§ qsâˆ¨qd
  # Extract strings and group into tags
  esâ€¿ee (â‰ `âŠ¸>qa)âŠ¸<Â¨â†©                 # Tag start and end including special
  "Unclosed tag bracket"_err es>(âˆ¨`âŒ¾âŒ½âˆ§qaâ‰¥âˆ¨`)ee
  os â† 1âŒ¾âŠ‘esâˆ¨Â»ee                     # Start of any object
  ts â† (sbâˆ¨Â«ğ•©âˆŠ"!?")<es               # Tag start < (non-special)
  te â† eeâˆ§tsâŠËœâŒˆ`esÃ—â†•â‰ ğ•©               # Tag end   >
  td â† (Â»âŠ¸âˆ§eq) < â‰ ` tb â† tsâˆ¨te       # Non-quote tag interior
  tw â† tdâˆ§ğ•©âˆŠwsâˆ¾"=" â‹„ sl â† ğ•©='/'
  rb â† osâˆ¨tdâˆ§sl<Â»âŠ¸>tw                # String boundaries (starts with 1)
  rs â† ğ•© âŠ”Ëœ 1-Ëœ(+`rb)Ã—Â¬tbâˆ¨tdâˆ§qbâˆ¨twâˆ¨sl# Extracted strings
  frâ€¿ta â† (âŠ‘â‹ˆ1âŠ¸â†“) (rb/tdÃ—+`ts) âŠ” rs  # Group attributes into their tags
  pt â† (2Ã—tsÂ»âŠ¸/sl)-ËœÂ¬teÂ«âŠ¸/sl         # Tag type: Â¯1 close, 0 void, 1 open
  ! âˆ§Â´â‰¡â—‹âŠ‘Â¨Ë ta âŠËœ (â‹âŠâŸœ(+`pt))âŠ¸âŠâˆ˜/Ë˜ Â¯1â€¿1=âŒœpt  # Tag matching
  opâ€¿v â† (âŠ‘â‹ˆÂ·â‰âˆ˜â€¿2â¥Š1â†“âŠ¢)Â¨Â¨ âŒ½ (ptâˆ¾2)âŠ”ta # Build tag data
  # Build result
  tag â† os/ts
  tt â† ptâŒ¾(tagâŠ¸/) tag
  [c,n,o]â†Â¯1â€¿0â€¿1=âŒœtt                 # Close, neither, open
  l â† +`âŒ¾((â‹+`tt)âŠ¸âŠ) o               # Parent index
  nvâ† â‰ vals â† (<Â¨fr) âˆ¾ v             # Initial set of values
  viâ† â‹â‹(fâ†Â¬o)/c                     # Value indices
  i â† vi âŠ (â‹â‹n/tag) âˆ¾ nv+â‰ âŠ¸-c/Â»l    # Adjust for collection ordering
  (âŸ¨âŸ©â‹ˆâŠ¸âˆ¾op) {valsâˆ¾â†©âŸ¨ğ•¨âˆ¾âŸ¨ğ•©âŠvalsâŸ©âŸ©â‹„@}Â¨â—‹âŒ½ ((1+Â´c)âˆ¾Ëœf/l)âŠ”i
  âŠ‘Â¯1âŠ‘vals
}
