# XML: Extensible Markup Language
âŸ¨
  Parse   # XML string to BQN
âŸ©â‡

# XML, and tag contents, are parsed to give a list of objects.
# Objects may be tags, special tags or text.
# Text is represented as an enclosed string.
# A special tag is also an enclosed string but starts and ends with <>.
# Tags are a list of:
# - Tag name
# - Attributes, as namesâ‰values
# - (unless void) Contents: list of text and tags

# The following open/close pairs form special tags:
# <!--       -->
# <![CDATA[  ]]>
# <!           >
# <?           >

ws â† @+9â€¿10â€¿13â€¿32                       # Tab, LF, CR, space
namestart â† âˆ§(â¥Š"Aa"+âŒœâ†•26)âˆ¾"_:"
namechar  â† âˆ§namestartâˆ¾('0'+â†•10)âˆ¾".-"   # (ASCII only)

E â† +`âŠ¸Ã—âŸœÂ¬-âŠ¢
Seâ†â‰ (>/âŠ¢)âˆ¾âŸœâ‰ {(âŠËœğ•¨)ğ•ŠâŸ(â‰ â—‹(Â¯1âŠ¸âŠ‘))ğ•©âˆ¾ğ•©âŠğ•¨}âŸ¨0âŸ©Ë™
Traceâ†{ğ•¨(Seâˆ˜â‹âŠâ‰Ë˜)â—‹((â‹ğ•¨)âŠ¸âŠ)ğ•©}â—‹âˆ¾

Parse â† {
  # Resolve special tags not closed by plain >
  Tr â† â‰ `âŠ¸>(â‰ ğ•©)â†‘Â·/â¼Â·â¥ŠTrace
  [sm,sn] â† (â‰ âˆ˜âŠ¢â†‘â·)âŸœğ•©Â¨["<!--"â€¿"<![CDATA[","-->"â€¿"]]>"]
  excl â† TrÂ´ âŸ¨/Â¨sm, sm(0âˆ¾+`)âŠ¸(-âŸœÂ»âˆ˜âŠËœ/âŠ¢)âŸœ(/âˆ¾âŸœ1)Â¨snâŸ©
  # And quotes
  exclâˆ¨â†© TrË Â¯1â€¿1â†“âŒœ(/excl<ğ•©âŠ¸=)Â¨"'"""
  # Extract tags
  tl â† +`-Â´tmâ†(excl<ğ•©âŠ¸=)Â¨"<>"
  "Ill-formed tag" ! (âˆ§Â´tlâˆŠ0â€¿1) âˆ§ 0=âŠ¢Â´tl
  osâ†âˆ¨âŸœÂ»Â´tm
  tag â† os/tsmâ†âŠ‘tm
  obj â† ((Â»Â«os)Eâˆ¨Â´tm)âŠ”ğ•©
  stâ† "!?"âˆŠËœtscâ†tsmÂ»âŠ¸/ğ•©
  gtâ† (2Ã—'/'=tsc)-ËœÂ¬stâˆ¨'/'=ğ•©/ËœÂ«1âŠ‘tm
  d â† +`ttâ†gtâŒ¾(tagâŠ¸/) tag            # Tag type: Â¯1 close, 0 void, 1 open
  [c,n,o]â†Â¯1â€¿0â€¿1=âŒœtt
  tpâ† (â‹âŠâŸœd)âŠ¸âŠâˆ˜/Ë˜ oâ‰c                # Tag pairs
  ! (âˆ§`' 'âŠ¸â‰ )âŠ¸/Â¨âŠ¸â‰¡âŸœ(1âŠ¸â†“Â¨)ËtpâŠobj     # Tag matching
  toâ† c<(Â¬st)âŒ¾(tagâŠ¸/) tag            # Tag objects, open or void
  opâ€¿v â† (to/n) âˆ¾âŸœ2âŠ¸âŠ” ParseAttrÂ¨ (-to/n)â†“Â¨ to/obj
  l â† +`âŒ¾((â‹d)âŠ¸âŠ) o                  # Parent index
  nvâ† â‰ vals â† (<Â¨obj/Ëœto<n) âˆ¾ v      # Initial set of values
  viâ† â‹â‹(fâ†Â¬o)/c                     # Value indices
  i â† vi âŠ (â‹â‹n/to) âˆ¾ nv+â‰ âŠ¸-c/Â»l     # Adjust for collection ordering
  (âŸ¨âŸ©â‹ˆâŠ¸âˆ¾op) {valsâˆ¾â†©âŸ¨ğ•¨âˆ¾âŸ¨ğ•©âŠvalsâŸ©âŸ©â‹„@}Â¨â—‹âŒ½ ((1+Â´c)âˆ¾Ëœf/l)âŠ”i
  âŠ‘Â¯1âŠ‘vals
}
ParseAttr â† {
  q â† (â‰ ğ•©)â†‘/â¼â¥ŠTraceË Â¯1â€¿1â†“âŒœ(/ğ•©âŠ¸=)Â¨"'""" # Duplicates work from Parse
  nameâ€¿a â† (âŠ‘â‹ˆ1âŠ¸â†“) (gâ†EËœ(â‰ `q)<' '=ğ•©)âŠ¸âŠ” ğ•©
  âŸ¨name, {0=â‰ a?2â€¿0â¥Š0;â‰>(1â†“gâŠ”q)((EËÂ·âˆ¨`'='âŠ¸=â‰âŠ£)âŠ”âŠ¢)Â¨a}âŸ©
}
